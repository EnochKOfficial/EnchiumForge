<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Enchium Forge | 3D Chemical Visual</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="https://chemapps.stolaf.edu/jmol/jsmol/JSmol.min.js"></script>

    <style>
        :root {
            --color-purple-primary: #7343e6;
            --color-purple-secondary: #d9c8f6;
            --color-purple-bg: #0a0511;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--color-purple-bg); 
            color: #f8f8f8; 
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll, let individual parts handle it */
        }

        .glass { background: rgba(115, 67, 230, 0.04); backdrop-filter: blur(24px); border: 1px solid rgba(115, 67, 230, 0.1); }
        
        /* FIX: Ensure Jmol is always below UI elements */
        .jmol-canvas-container { 
            position: relative;
            z-index: 10; 
            background: #000;
            border: 1px solid rgba(115, 67, 230, 0.2);
            border-radius: 2rem;
            overflow: hidden;
            flex-grow: 1;
            min-height: 350px; /* Essential for mobile rendering */
        }

        /* FIX: Forge Manual Layering */
        #tutorialPane {
            z-index: 9999 !important; /* Forces it above Jmol's internal layers */
        }

        /* Desktop Layout Fixes */
        @media (min-width: 1024px) {
            .main-content { flex-direction: row; }
            .jmol-canvas-container { border-radius: 3rem; }
        }

        #jmolDiv { width: 100%; height: 100%; }
        
        /* Custom scrollbar for sidebar */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--color-purple-primary); border-radius: 10px; }
    </style>
</head>
<body class="p-3 lg:p-6 gap-3 lg:gap-6">

    <header class="glass rounded-[1.5rem] lg:rounded-[2.5rem] p-4 lg:p-6 flex justify-between items-center shadow-2xl shrink-0">
        <div class="flex items-center gap-3 lg:gap-6">
            <img src="Enchium Logo.jpg" alt="Enchium Forge Logo" class="w-10 h-10 lg:w-16 lg:h-16 rounded-xl shadow-lg border border-white/5">
            <div>
                <h1 class="text-base lg:text-2xl font-black tracking-tighter uppercase italic">Enchium <span class="font-extralight not-italic" style="color: var(--color-purple-secondary);">Forge</span></h1>
                <p class="hidden sm:block text-[9px] lg:text-[10px] text-gray-500 font-bold uppercase tracking-widest">Engineering 2025</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4 lg:gap-8">
            <div class="text-right hidden sm:block border-r border-white/5 pr-4 lg:pr-8">
                <p class="text-[8px] lg:text-[10px] font-bold uppercase tracking-widest text-purple-300">Active Build</p>
                <p id="currentMol" class="text-xs lg:text-lg font-mono text-white font-black uppercase">Caffeine</p>
            </div>
            <button onclick="toggleTutorial()" class="px-4 py-2 lg:px-8 lg:py-4 rounded-xl lg:rounded-2xl text-[10px] lg:text-xs font-black uppercase tracking-widest transition text-white" style="background-color: var(--color-purple-primary);">
                Manual
            </button>
        </div>
    </header>

    <div class="flex flex-col lg:flex-row flex-grow gap-3 lg:gap-6 min-h-0 main-content">
        
        <main class="flex-[2] flex flex-col gap-3 lg:gap-6 min-h-0">
            <div class="jmol-canvas-container">
                <div id="jmolDiv"></div>
                <div class="absolute top-4 left-4 glass px-3 py-1 rounded-full text-[8px] font-bold tracking-widest text-purple-400 border-purple-500/20">
                    LIVE_RENDER_V7
                </div>
            </div>

            <div class="glass p-2 lg:p-4 rounded-2xl flex gap-3 shrink-0">
                <input type="text" id="cmdInput" placeholder="Inject Jmol script..." 
                       class="flex-grow bg-transparent px-4 text-xs lg:text-sm outline-none font-mono" style="color: var(--color-purple-secondary);">
                <button onclick="execCmd()" class="bg-purple-600 px-4 lg:px-8 py-2 lg:py-3 rounded-xl lg:rounded-2xl text-[10px] font-black uppercase transition text-white">Run</button>
            </div>
        </main>

        <aside class="w-full lg:w-80 flex flex-col gap-3 lg:gap-6 shrink-0 lg:overflow-y-auto custom-scroll">
            <div class="glass p-4 lg:p-6 rounded-[1.5rem] lg:rounded-[2.5rem] space-y-4">
                <h3 class="text-[9px] font-black text-gray-500 uppercase tracking-widest flex items-center gap-2">
                    <i data-lucide="search" class="w-3 h-3 text-purple-300"></i> Discovery Engine
                </h3>
                <input type="text" id="dbSearch" list="molSuggestions" placeholder="Compound Name..." 
                       class="w-full bg-black/50 border border-white/10 p-3 rounded-xl text-sm outline-none focus:border-purple-500 transition">
                <datalist id="molSuggestions"></datalist>
                <button onclick="searchDB()" class="w-full bg-purple-600/10 border border-purple-500/20 p-3 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-purple-500/20 transition" style="color: var(--color-purple-secondary);">
                    Forge Compound
                </button>
            </div>

            <div class="glass p-4 lg:p-6 rounded-[1.5rem] lg:rounded-[2.5rem] space-y-3">
                <h3 class="text-[9px] font-black text-gray-500 uppercase tracking-widest">Visual Schematics</h3>
                <div class="grid grid-cols-2 lg:grid-cols-1 gap-2">
                    <button onclick="toggleLabels()" id="labelBtn" class="glass border-white/5 p-3 rounded-xl text-[10px] font-bold flex justify-between items-center group hover:border-purple-500/50">
                        <span>Atom Labels</span>
                        <div id="labelIndicator" class="w-2 h-2 rounded-full bg-gray-700"></div>
                    </button>
                    <button onclick="setRender('ball')" class="glass border-white/5 p-3 rounded-xl text-[10px] font-bold text-left hover:border-purple-500/50">Ball & Stick</button>
                    <button onclick="setRender('spacefill')" class="glass border-white/5 p-3 rounded-xl text-[10px] font-bold text-left hover:border-purple-500/50">Van der Waals</button>
                    <button onclick="loadNextProtein()" class="glass p-3 rounded-xl text-[10px] font-bold text-purple-400 border-purple-500/20 bg-purple-500/5">Cycle Protein</button>
                </div>
            </div>
        </aside>
    </div>

    <div id="tutorialPane" class="fixed inset-6 sm:inset-12 lg:inset-auto lg:top-1/2 lg:left-1/2 lg:-translate-x-1/2 lg:-translate-y-1/2 lg:w-[500px] glass p-8 lg:p-12 rounded-[2rem] lg:rounded-[3.5rem] hidden shadow-[0_0_100px_rgba(0,0,0,0.9)] border-purple-500/30">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-xl lg:text-2xl font-black text-purple-300">Forge Manual</h2>
            <button onclick="toggleTutorial()"><i data-lucide="x" class="w-6 h-6 hover:text-red-500 transition"></i></button>
        </div>
        <div class="space-y-6">
            <div class="p-6 bg-purple-600/10 rounded-3xl border border-purple-500/20">
                <p class="text-gray-300 text-xs lg:text-sm leading-relaxed mb-6 italic text-center">Reference the Molecular Master Guide for advanced Jmol scripts and protocols.</p>
                <a href="https://earth.callutheran.edu/Academic_Programs/Departments/BioDev/omm/jsmol/scripting/molmast.htm" 
                   target="_blank" 
                   class="block text-center p-4 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg"
                   style="background-color: var(--color-purple-primary);">
                   Open Documentation <i data-lucide="external-link" class="inline w-3 h-3 ml-1"></i>
                </a>
            </div>
            <div class="text-[10px] text-gray-600 font-mono text-center">
                ENCHIUM FORGE SYSTEM // BUILD 2025.12
            </div>
        </div>
    </div>

    <script>
        var jmolApplet;
        var activeCompound = "caffeine";
        var labelsOn = false;
        var proteinList = ['1crn', '1alu', '1bna', '1tna', '7d9o'];
        var proteinIndex = 0;

        // Optimized Jmol Info for Mobile
        var Info = {
            width: "100%", height: "100%", debug: false, color: "#000000", use: "HTML5",
            j2sPath: "https://chemapps.stolaf.edu/jmol/jsmol/j2s",
            readyFunction: function(applet) { 
                jmolApplet = applet; 
                // Fix for mobile rendering on initial load
                setTimeout(() => Jmol.script(jmolApplet, "refresh;"), 100);
            },
            script: "load $caffeine; wireframe 0.15; spacefill 23%; antialiasDisplay = true;"
        };

        $(document).ready(function() {
            $("#jmolDiv").html(Jmol.getAppletHtml("jmolApplet", Info));
            lucide.createIcons();
            $("#dbSearch").on('keypress', (e) => { if(e.which == 13) searchDB(); });
            $("#cmdInput").on('keypress', (e) => { if(e.which == 13) execCmd(); });
        });

        // 1. Z-INDEX SECURE TOGGLE
        function toggleTutorial() { 
            const pane = $("#tutorialPane");
            pane.fadeToggle(200); 
        }

        // 2. MOBILE COMMAND FIX
        function runScript(cmd) { 
            if(jmolApplet) {
                Jmol.script(jmolApplet, cmd); 
            } else {
                console.error("Forge Engine not ready.");
            }
        }

        function searchDB() {
            const query = $("#dbSearch").val().trim();
            if (!query) return;
            runScript(`zap; load "$${query}"; wireframe 0.15; spacefill 23%;`);
            activeCompound = query;
            $("#currentMol").text(query);
            $("#dbSearch").val("");
            if(labelsOn) setTimeout(() => runScript("label %a; color label white;"), 500);
        }

        function toggleLabels() {
            labelsOn = !labelsOn;
            if (labelsOn) {
                runScript("label %a; color label white; set labelOffset 0 0; font label 12 sanserif bold;");
                $("#labelIndicator").addClass("bg-purple-400 shadow-[0_0_10px_#7343e6]");
            } else {
                runScript("label off;");
                $("#labelIndicator").removeClass("bg-purple-400 shadow-[0_0_10px_#7343e6]");
            }
        }

        function setRender(type) {
            if (type === 'ball') runScript("wireframe 0.15; spacefill 23%; cartoons off;");
            if (type === 'spacefill') runScript("wireframe off; spacefill 100%; cartoons off;");
        }

        function loadNextProtein() {
            proteinIndex = (proteinIndex + 1) % proteinList.length;
            const pdbId = proteinList[proteinIndex];
            activeCompound = pdbId;
            $("#currentMol").text("PDB: " + pdbId.toUpperCase());
            runScript(`zap; load =${pdbId}; cartoons on; color structure;`);
        }

        function execCmd() {
            runScript($("#cmdInput").val());
            $("#cmdInput").val("");
        }
    </script>
</body>
</html>
